{{ if not .IsPage }}
<div id="disco-root" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 50; overflow: hidden; user-select: none;"></div>

<style>
    /* æ ¸å¿ƒåŠ¨ç”» */
    @keyframes discoSpin {
        from { transform: translate(-50%, -50%) rotate(0deg); }
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    @keyframes discoSpinReverse {
        from { transform: translate(-50%, -50%) rotate(360deg); }
        to { transform: translate(-50%, -50%) rotate(0deg); }
    }
    @keyframes discoPulse {
        0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.9); }
        50% { opacity: 0.9; transform: translate(-50%, -50%) scale(1.1); }
    }

    /* å®¹å™¨æ ·å¼ */
    .disco-layer-container {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 200vmax;
        height: 200vmax;
        transform-origin: center center;
        will-change: transform;
    }
    
    .disco-spot {
        position: absolute;
        border-radius: 50%;
        transform-origin: center center;
        mix-blend-mode: screen; 
    }
</style>

<script>
(function() {
    const root = document.getElementById('disco-root');
    if (!root) return;

    // ğŸ¨ æä¹è¿ªæ–¯ç§‘Â·ä½é¥±å’Œç‰¹è°ƒç‰ˆ (ä¿æŒä¸å˜)
    const subtleVibeColorsRGB = [
        '120, 140, 170', // é˜´é›¨ç°è“
        '210, 195, 160', // ç¾Šçš®çº¸é»„
        '160, 150, 180', // å°˜åŸƒæ·¡ç´«
        '140, 165, 160', // è‹¦è‰¾é…’ç°ç»¿
    ];

    // å±‚çº§é…ç½® (ç¨å¾®å‡å°äº†å†…å±‚çš„å°ºå¯¸åŸºæ•°ï¼Œä¸ºäº†å¯¹æ¯”å‡ºå¤–å±‚çš„å¤§)
    const layerConfigs = [
        { radiusMin: 5,  radiusMax: 20,  count: 20, sizeBase: 8,  duration: 45, reverse: false, blur: 2 },
        { radiusMin: 20, radiusMax: 45,  count: 30, sizeBase: 12, duration: 65, reverse: true,  blur: 3 },
        { radiusMin: 45, radiusMax: 75,  count: 45, sizeBase: 16, duration: 55, reverse: false, blur: 4 },
        { radiusMin: 75, radiusMax: 110, count: 60, sizeBase: 22, duration: 80, reverse: true,  blur: 6 },
        { radiusMin: 110,radiusMax: 160, count: 80, sizeBase: 28, duration: 70, reverse: false, blur: 8 },
    ];

    const random = (min, max) => Math.random() * (max - min) + min;

    layerConfigs.forEach((config) => {
        const layerDiv = document.createElement('div');
        layerDiv.className = 'disco-layer-container';
        
        const animName = config.reverse ? 'discoSpinReverse' : 'discoSpin';
        layerDiv.style.animation = `${animName} ${config.duration}s linear infinite`;
        
        for (let i = 0; i < config.count; i++) {
            const spot = document.createElement('div');
            spot.className = 'disco-spot';

            // --- ä½ç½® ---
            const angle = Math.random() * Math.PI * 2;
            const dist = random(config.radiusMin, config.radiusMax);
            const left = 50 + (Math.cos(angle) * dist) / 2; 
            const top = 50 + (Math.sin(angle) * dist) / 2;

            // --- æ ¸å¿ƒä¿®æ”¹åŒºï¼šå°ºå¯¸ä¸å½¢çŠ¶ ---
            
            // 1. è®¡ç®—è·ç¦»ç³»æ•° (0åœ¨ä¸­å¿ƒ, 1åœ¨è¾¹ç¼˜)
            const normalizedDist = Math.min(dist / 150, 1);

            // 2. è®¡ç®—å®½åº¦ (Width) - å¼•å…¥è·ç¦»æ”¾å¤§ç³»æ•°
            // è¾¹ç¼˜çš„å…‰æ–‘åŸºç¡€å¤§å°æ˜¯ä¸­å¿ƒçš„ 2.5 å€å·¦å³
            const baseWidth = config.sizeBase + Math.random() * 8;
            const sizeMultiplier = 1.0 + (normalizedDist * 1.5); 
            const w = baseWidth * sizeMultiplier;

            // 3. è®¡ç®—æ‹‰ä¼¸æ¯” (Curvature) - å¤§å¹…å¢åŠ è¾¹ç¼˜æ‹‰ä¼¸
            // ä¸­å¿ƒä¿æŒ 1.5å€å¾®æ¤­åœ†
            // è¾¹ç¼˜æ‹‰ä¼¸å¢åŠ  4.0å€ï¼Œæ€»æ›²ç‡å¯è¾¾ 5.5å€ (éå¸¸ç»†é•¿)
            const baseElongation = 1.5; 
            const distanceStretch = normalizedDist * 4.0; 
            const curvature = baseElongation + distanceStretch;
            
            // 4. è®¡ç®—é«˜åº¦ (Height)
            const h = w * curvature;

            // --- é¢œè‰²ä¸é€æ˜åº¦ (ä¿æŒä¸å˜) ---
            const opacityBase = 0.9 - (normalizedDist * 0.4);

            const isColored = Math.random() > 0.65; 
            let colorString;
            
            if (isColored) {
                const rgb = subtleVibeColorsRGB[Math.floor(Math.random() * subtleVibeColorsRGB.length)];
                colorString = `rgba(${rgb}, ${opacityBase * 0.9})`; 
            } else {
                colorString = `rgba(255, 250, 235, ${opacityBase * 0.8})`;
            }

            // --- æ ·å¼åº”ç”¨ ---
            spot.style.width = w + 'px';
            spot.style.height = h + 'px';
            spot.style.left = left + '%';
            spot.style.top = top + '%';
            
            spot.style.background = `radial-gradient(ellipse at 50% 50%, ${colorString} 20%, rgba(0,0,0,0) 65%)`;
            
            // æ—‹è½¬
            const rotation = (angle * 180) / Math.PI + 90;
            spot.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
            spot.style.filter = `blur(${config.blur}px)`;
            
            // åŠ¨ç”»
            spot.style.animation = `discoPulse ${4 + Math.random() * 3}s ease-in-out infinite alternate`;
            spot.style.animationDelay = `${Math.random() * 5}s`;

            layerDiv.appendChild(spot);
        }

        root.appendChild(layerDiv);
    });
})();
</script>

<div id="glass-player" class="glass-btn" title="Play/Pause BGM">
    <audio id="bgm-audio" loop preload="auto">
        <source src="/bgm.mp3" type="audio/mpeg">
    </audio>

    <svg id="icon-play" viewBox="0 0 24 24" fill="currentColor">
        <path d="M8 5v14l11-7z"/>
    </svg>

    <svg id="icon-pause" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
    </svg>
</div>

<style>
    /* æ¯›ç»ç’ƒæŒ‰é’®æ ·å¼ */
    .glass-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%; /* åœ†å½¢ */
        
        /* æ¯›ç»ç’ƒæ ¸å¿ƒä»£ç  */
        background: rgba(255, 255, 255, 0.07); /* ææ·¡çš„ç™½ */
        backdrop-filter: blur(10px);           /* æ¨¡ç³ŠèƒŒæ™¯ */
        -webkit-backdrop-filter: blur(10px);   /* å…¼å®¹ Safari */
        border: 1px solid rgba(255, 255, 255, 0.2); /* å¾®å¾®å‘å…‰çš„è¾¹æ¡† */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        
        /* å±…ä¸­å›¾æ ‡ */
        display: flex;
        align-items: center;
        justify-content: center;
        
        cursor: pointer;
        z-index: 999; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
        transition: all 0.3s ease;
        color: rgba(255, 255, 255, 0.8); /* å›¾æ ‡é»˜è®¤é¢œè‰² */
    }

    /* é¼ æ ‡æ‚¬åœï¼šå˜äº®ï¼Œä¸Šæµ® */
    .glass-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
        transform: translateY(-2px) scale(1.05);
        color: #fff; /* å›¾æ ‡å˜çº¯ç™½ */
    }

    /* æ’­æ”¾æ—¶çš„å¾®å…‰å‘¼å¸æ•ˆæœ */
    .glass-btn.playing {
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    /* å›¾æ ‡å¤§å° */
    .glass-btn svg {
        width: 24px;
        height: 24px;
    }
</style>

<script>
(function() {
    const playerBtn = document.getElementById('glass-player');
    const audio = document.getElementById('bgm-audio');
    const iconPlay = document.getElementById('icon-play');
    const iconPause = document.getElementById('icon-pause');

    // ğŸ”„ 1. è®°å¿†æ¢å¤åŠŸèƒ½ (Session Persistence)
    // é¡µé¢åŠ è½½æ—¶ï¼Œæ£€æŸ¥ sessionStorage
    const savedTime = sessionStorage.getItem('bgm-time');
    const savedStatus = sessionStorage.getItem('bgm-playing');

    if (savedTime) {
        audio.currentTime = parseFloat(savedTime);
    }

    // æ›´æ–° UI çŠ¶æ€çš„å‡½æ•°
    function updateUI(isPlaying) {
        if (isPlaying) {
            playerBtn.classList.add('playing');
            iconPlay.style.display = 'none';
            iconPause.style.display = 'block';
        } else {
            playerBtn.classList.remove('playing');
            iconPlay.style.display = 'block';
            iconPause.style.display = 'none';
        }
    }

    // å¦‚æœä¹‹å‰æ˜¯æ’­æ”¾çŠ¶æ€ï¼Œå°è¯•è‡ªåŠ¨ç»§ç»­æ’­æ”¾
    if (savedStatus === 'true') {
        // æ³¨æ„ï¼šæµè§ˆå™¨å¯èƒ½ä¼šæ‹¦æˆªè‡ªåŠ¨æ’­æ”¾ï¼Œéœ€è¦ catch é”™è¯¯
        const playPromise = audio.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                updateUI(true);
            }).catch(error => {
                console.log("Auto-resume blocked by browser (normal behavior):", error);
                // å¦‚æœè¢«æ‹¦æˆªï¼Œé‡ç½®ä¸ºæš‚åœçŠ¶æ€
                updateUI(false);
                sessionStorage.setItem('bgm-playing', 'false');
            });
        }
    }

    // ğŸ–±ï¸ 2. ç‚¹å‡»äº¤äº’
    playerBtn.addEventListener('click', () => {
        if (audio.paused) {
            audio.play();
            updateUI(true);
            sessionStorage.setItem('bgm-playing', 'true');
        } else {
            audio.pause();
            updateUI(false);
            sessionStorage.setItem('bgm-playing', 'false');
        }
    });

    // ğŸ’¾ 3. å®æ—¶è®°å½•è¿›åº¦ (ä¸ºäº†è·³è½¬ä¸ä¸¢å¤±è¿›åº¦)
    window.addEventListener('beforeunload', () => {
        sessionStorage.setItem('bgm-time', audio.currentTime);
        // çŠ¶æ€å·²ç»åœ¨ click æ—¶å­˜äº†ï¼Œè¿™é‡Œä¸ç”¨é‡å¤å­˜
    });

    // ğŸ¤ 4. æ™ºèƒ½é¿è®© (Global Conflict Resolver)
    // ç›‘å¬å…¨ç«™æ‰€æœ‰éŸ³é¢‘çš„æ’­æ”¾äº‹ä»¶
    document.addEventListener('play', function(e) {
        // å¦‚æœå¼€å§‹æ’­æ”¾çš„ä¸æ˜¯ BGM éŸ³é¢‘ï¼Œå¹¶ä¸” BGM æ­£åœ¨å“
        if (e.target !== audio && !audio.paused) {
            audio.pause();
            updateUI(false);
            sessionStorage.setItem('bgm-playing', 'false');
            console.log("BGM paused because another audio started.");
        }
    }, true); // ä½¿ç”¨æ•è·æ¨¡å¼ ensure catching all events

})();
</script>
{{ end }}